# Обработчик видеопотоков с камер

Система принимает видеопотоки с RTSP-камер, агрегирует кадры в единое изображение (батч) и передаёт его в нейронную сеть для выполнения инференса.

---

## Общая архитектура


```
   [ Web / GUI ]
          |
          |  REST API
          v
 [ Server (Flask) ]
          |
          |  Callbacks / API
          v
      [ Manager ]
         |   \
         |    \
         v     v
 [ CameraStream ] ---> [ NeuralLoader ]
```

---

## CameraStream

Класс `CameraStream` реализует получение кадров с камер в режиме реального времени.

- Подключение к камерам осуществляется по RTSP.
- Декодирование видеопотока выполняется через `ffmpeg` с использованием аппаратного декодера **MPP**.
- Кадры передаются в `Manager` через callback-функцию.
- `Manager` хранит последние кадры от всех активных камер и использует их для формирования батчей, которые передаются в нейронные загрузчики (`NeuralLoader`).

---

### Входные данные CameraStream

| Поле                  | Тип            | Обязательное | Описание                                   |
| --------------------- | -------------- | ------------ | ------------------------------------------ |
| `camera_name`         | string         | да           | Уникальное имя камеры (например `Camera_1`) |
| `rtsp_url`            | string         | да           | RTSP URL камеры                            |
| `width`               | int \| None    | нет          | Принудительная ширина кадра                |
| `height`              | int \| None    | нет          | Принудительная высота кадра                |
| `reconnect_interval`  | int            | нет          | Интервал переподключения (в секундах)      |
| `log_level`           | int            | нет          | Уровень логирования (0, 10, 20 и т.д.)     |

> **Примечание:**  
> Рекомендуется оставлять `width` и `height` равными `None`. В этом случае будут использованы оригинальные параметры видеопотока камеры.

---

### Команды для сервера и Web-интерфейса (CameraStream)

- Добавить камеру
- Редактировать параметры камеры (по уникальному имени)
- Проверить статус подключения камеры
- Удалить камеру

---

## NeuralLoader

Класс `NeuralLoader` отвечает за запуск нейронной сети на сформированном батче изображений с камер.

- Принимает кадры в формате **NV12**
- Выполняет преобразование **NV12 → RGB**
- Запускает инференс модели **YOLO**
- Отдаёт результат в виде видеопотока (MJPEG)

---

### Входные данные NeuralLoader

| Поле              | Тип                | Обязательное | Описание                          |
| ----------------- | ------------------ | ------------ | --------------------------------- |
| `loader_name`     | string             | да           | Уникальное имя загрузчика         |
| `weights_path`    | string             | да           | Путь к файлу весов нейросети      |
| `classes_path`    | string             | да           | Путь к файлу с классами           |
| `img_size`        | int                | да           | Размер входного изображения       |
| `server_endpoint` | string             | да           | Endpoint вывода результата        |
| `loader_matrix`   | list[list[string]] | да           | Матрица камер для формирования батча |

---

### Описание `loader_matrix`

`loader_matrix` определяет, **как именно кадры с камер будут размещены внутри одного батча**, который подаётся в нейронную сеть.

Матрица представляет собой двумерный список:
- каждая строка — отдельный ряд изображений
- каждый элемент строки — имя камеры

---

#### Примеры

**Пример 1**
```
LOADER_MATRIX = [
    ["Camera_1"],
    ["Camera_2"]
]
```
Батч состоит из двух кадров:
- сверху — кадр с камеры `Camera_1`
- снизу — кадр с камеры `Camera_2`

---

**Пример 2**
```
LOADER_MATRIX = [
    ["Camera_1", "Camera_2"],
    ["Camera_3"]
]
```
Батч состоит из трёх кадров:
- верхний ряд:  
  - слева — `Camera_1`  
  - справа — `Camera_2`
- нижний ряд:
  - один кадр от `Camera_3`, занимающий всю ширину

---

**Пример 3**

```
LOADER_MATRIX = [
    ["Camera_1"]
]
```
Батч состоит из одного кадра с камеры `Camera_1`.

---

> **ВАЖНО:**  
> Максимальное количество одновременно работающих загрузчиков — **3**.  
> Это ограничение связано с количеством аппаратных потоков на устройстве Orange.  
> Распределение загрузчиков по потокам выполняется автоматически на стороне сервера.

---

### Команды для сервера и Web-интерфейса (NeuralLoader)

- Добавить новый загрузчик
- Редактировать загрузчик (по уникальному имени)
- Остановить загрузчик
- Запустить загрузчик

---

### Ограничения и правила редактирования загрузчика

При добавлении загрузчика необходимо:
- проверять существование всех камер, указанных в `loader_matrix`

Во время редактирования загрузчика допускается:
- изменение URL вывода изображения (из списка доступных)
- изменение матрицы батча (`loader_matrix`)
- смена нейронной модели  
  (необходимо указать **и веса, и файл классов**)
- изменение размера создаваемого батча  
  (размер всегда квадратный)

---

### Доступные URL для вывода изображения
```
http://<server_ip>:<port>/neural_1
http://<server_ip>:<port>/neural_2
http://<server_ip>:<port>/neural_3
```
- Каждый URL соответствует отдельному загрузчику
- Видеопоток отдаётся в формате **Motion JPEG (MJPEG)**

---

### Параметры нейронной сети

В конфигурации передаются **пути к локальным файлам**.  
Все файлы должны находиться на сервере.
```
Классы в файле .json
Веса в файле .rknn
```
Загрузчик самостоятельно открывает и инициализирует указанные файлы.